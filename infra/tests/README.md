# Инфраструктурные проверки стека

Сценарий `stack-health-check.sh` поднимает инфраструктурный стек из `infra/docker-compose.yml`,
ожидает успешный health-check для сервисов `postgres`, `n8n` и `ai-memory-service`, а затем
гарантированно останавливает контейнеры.

## Запуск

```bash
./infra/tests/stack-health-check.sh
```

По умолчанию используется файл окружения `.env.test`. Его можно переопределить переменной
`ENV_FILE`. Файл docker-compose можно изменить через `COMPOSE_FILE`.

## Переменные окружения

| Переменная | Значение по умолчанию | Назначение |
| --- | --- | --- |
| `STACK_HEALTH_SERVICES` | `"postgres n8n ai-memory-service"` | Список сервисов, health-check которых необходимо дождаться |
| `STACK_HEALTH_TIMEOUT` | `300` | Таймаут (в секундах) ожидания статуса `healthy` для каждого сервиса |
| `STACK_HEALTH_INTERVAL` | `5` | Интервал (в секундах) между проверками статуса |
| `COMPOSE_FILE` | `infra/docker-compose.yml` | Путь к файлу docker-compose |
| `ENV_FILE` | `.env.test` | Путь к файлу с переменными окружения |

## Ограничения

- Для работы необходим установленный Docker и плагин Docker Compose.
- Таймаут ожидания задаётся глобально для каждого сервиса. Для медленных запусков его можно
  увеличить через `STACK_HEALTH_TIMEOUT`.
- Проверки зависят от наличия health-check у каждого сервиса. Для `n8n` используется эндпоинт
  `http://localhost:5678/healthz`, который должен быть доступен внутри контейнера.
- Сценарий всегда выполняет `docker compose down --volumes --remove-orphans`, поэтому данные
  контейнеров будут удалены после выполнения теста.
